<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat LOMI</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="sidebar">
        <header>Conversas</header>
        <div class="chat-list">
            <div class="chat-item active">Grupo da Sala</div>
            <div class="chat-item">Transporte Matinhos</div>
            <div class="chat-item">Fam√≠lia</div>
            <div class="chat-item">Meninas</div>
        </div>
    </div>

    <div class="main-chat">
        <header>Grupo da Sala</header>
        <ul id="messages"></ul>
        <form id="form">
            <input id="input" autocomplete="off" placeholder="Digite uma mensagem..." />
            <button>Enviar</button>
        </form>
    </div>

    <script>
        const socket = io();
        const form = document.getElementById('form');
        const input = document.getElementById('input');
        const messages = document.getElementById('messages');
        const chatItems = document.querySelectorAll('.chat-item');

        let currentRoom = 'Grupo da Sala';
        let username = "";

        // Cria popup para o nome
        const popup = document.createElement('div');

        popup.classList.add('popup');
        popup.innerHTML = `
          <div class="popup-content">
            <h2>Bem-vindo!</h2>
            <p>Digite seu nome para entrar no chat:</p>
            <input type="text" id="usernameInput" placeholder="Seu nome..." />
            <button id="enterBtn">Entrar</button>
          </div>
        `;
        document.body.appendChild(popup);

        //salva o nome e entra na sala
        document.getElementById('enterBtn').addEventListener('click', () => {
            const nameInput = document.getElementById('usernameInput').value.trim();
            if (nameInput !== "") {
                username = nameInput;
                popup.style.display = 'none';
                socket.emit('joinRoom', currentRoom, username);
            }
        });

        // Envia mensagem
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            if (input.value && username) {
                socket.emit('message', { room: currentRoom, username, msg: input.value });
                input.value = '';
            }
        });

        // Recebe mensagens antigas da sala
        socket.on('loadMessages', (msgs) => {
            messages.innerHTML = ''; 
            msgs.forEach(({ username: sender, msg }) => {
                const self = sender === username;
                addMessage(`${sender}: ${msg}`, self);
            });
        });

        // Recebe mensagem em tempo real
        socket.on('message', ({ username: sender, msg }) => {
            const self = sender === username;
            addMessage(`${sender}: ${msg}`, self);
        });

        // Troca de sala
        chatItems.forEach((item) => {
            item.addEventListener('click', () => {
                document.querySelector('.chat-item.active')?.classList.remove('active');
                item.classList.add('active');
                currentRoom = item.textContent.trim();
                document.querySelector('.main-chat header').textContent = currentRoom;
                messages.innerHTML = '';
                socket.emit('joinRoom', currentRoom, username);
            });
        });

        function scrollToBottom() {
            messages.scrollTop = messages.scrollHeight;
        }

        // Adiciona mensagens
        function addMessage(message, isSelf) {
            const li = document.createElement('li');
            li.textContent = message;
            li.classList.add(isSelf ? 'self' : 'received');
            document.getElementById('messages').appendChild(li);
            scrollToBottom();
        }

    </script>

</body>

</html>